name: Packaging Windows (PyInstaller)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to upload to (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    name: Build Windows EXE and upload to Release
    runs-on: windows-latest
    env:
      RELEASE_TAG: ${{ github.event.inputs.tag || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install build dependencies
        run: |
          pip install -r candidate-dedup-tool/requirements.txt
          pip install pyinstaller

      - name: Build with PyInstaller
        working-directory: candidate-dedup-tool
        run: python build_exe.py --onefile

      - name: List build output
        working-directory: candidate-dedup-tool
        run: dir dist || echo "no dist"

      - name: Install GitHub CLI
        uses: cli/gh-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact to Release
        working-directory: candidate-dedup-tool
        run: |
          set TAG_TO_USE=%RELEASE_TAG%
          echo "Uploading artifacts for tag %TAG_TO_USE%"
          for %%f in (dist\*) do (
            gh release upload %TAG_TO_USE% "%%f" --clobber || (
              echo "Failed to upload %%f to release %TAG_TO_USE% - creating release and retrying" && \
              gh release create %TAG_TO_USE% --title %TAG_TO_USE% --notes "Automated release for %TAG_TO_USE%" && \
              gh release upload %TAG_TO_USE% "%%f" --clobber
            )
          )
